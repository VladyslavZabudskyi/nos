# Лабораторна робота №1 - розгортання інстанса з Wordpress у AWS за допомогою Ansible

## **В якості мастер-хоста було використано Debian 12**

### Крок 1 - встановлення Ansible
Виконуємо встановлення Ansible за [інстукцією на офіційному сайті](https://docs.ansible.com/ansible/latest/installation_guide/installation_distros.html#installing-ansible-on-debian), а саме підключаємо репозиторій Ubuntu, оскільки так можемо отримати свіжі версії самого Ansible та колекцій до нього (колеція aws дуже чутлива до версії Ansible).

Після цього за допомогою наступної команди встановлюємо колекцію ```amazon.aws```: 
```
ansible-galaxy collection install amazon.aws
```
Версію колекції можна подивитися так:
```
ansible-galaxy collection list
```
**Примітка: може знадобитися встановити наступні бібліотеки Python:** ```apt install python3-boto python3-botocore```

### Крок 2 - скрипт динамічного репозиторію
Наданий у книжці скрипт динамічного інвентаря ec2.py, який на момент певно 2014 року був актуальним, застарів на момент виконання лабораторної роботи:
- AWS просто перестав підтримувати версію бібліотеки boto, яка використовується у цьому скрипті
- Сам скрипт написаний на Python 2, встановлення якого паралельно з сучасним Python є досить нетривіальною і задачею, до того ж не вигідною з точки зору функціоналу та використання часу.

Тому, замінюємо ec2.py на ec2.aws_ec2.yml використовуючи ```amazon.aws.aws_ec2 ``` - плагін колекції amazon.aws, який формувати інвентар з хостів у AWS EC2.

### Крок 3 - скрипт розгортання інстанса у AWS EC2
```provisioning.yml``` - скрипт розгоратння інстанса у AWS EC2. Фактично, він виконує наступні дії:
- створює пару ключів для доступу до інстанса
- копіює приватний ключ на мастер-хост
- створює сек'юріті групу
- створює інстанс
- аллокує публічну ip адресу
- асоціює публічну ip адресу з хостом

В переважній більшості випадків довелося поміняти назву модулів, інколи ще й параметрів.

**УВАГА - маніпуляції з публічною адресою (модуль ec2_eip) не є ідемпотентними. Тому необхідно кожен раз перед розгоратанням видаляти створену eip-адресу**


### Крок 4 - скрипт розгортання Wordpress на LAMP
```site.yml``` - скрипт розгортання LAMP з Wordpress. Для зручності (і випадку книжки використання у майбутніх завдань) було створено низку ролей: web, mysql та wordpress. Кожна з ролей містить свої плейбуки, шаблони конфігурацій та хендлери. Наступні ролі було модифіковано:
- web. Довелося повністю поміняти плейбук цієї ролі та додати конфігурацію для httpd. За 11 років вимоги Wordpress до конфігурації httpd змінилися, як і сам процес конфігурації httpd.
- mysql. Довелося поміняти залежності для встановлення MySQL.
Також довелося додати ще одну роль - php. Вона вміщує в собі інсталяцію необхідних залежностей PHP у стеку LAMP для Wordpress.

### Крок 5 - створення скрипта для придушення повстання машин
```termination.yml``` - скрипт, який фактично відкатує всі дії, виконані скриптом ```provisioning.yml```. Він не обов'язковий і не є частиною лабораторної роботи, проте значно полегшує життя при її виконання.

### Висновок
В процесі лабораторної роботи було розгорнуто сервер у хмарному середовищі AWS EC2 з встановленим стеком LAMP та Wordpress за допомогою Ansible. Ansible виявився дійсно зручним інструментом для виконання цього завдання, оскільки конфігурація та виконання більшості дій зводилося до задання правильних параметрів одному модулю, а небажане повторювання цих змін уникалося за домогою підтримуваної Ansible концепції ідемпотентності. Також, будо використано скрипт динамічного інвентаря, який ще більше автоматизував розгортання, позбавивши потреби вводити вручну параметри з AWS у необхідні змінні плейбука кожен раз при розгортанні. Основною незручністю використання Ansible для AWS є вибагливість колекції amazon.aws до версії Ansible, та подейкуди необхідність встановлення сторонніх бібліотек Python для роботи відповідного модуля.
